<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#ffffff">
    <meta name="description" content="استیکر تقویم بازرگانی درویشی - لوازم جانبی موبایل">
    
    <link rel="manifest" href="manifest.json">
    
    <!-- آیکون تقویم فارسی (طراحی شده به صورت کد SVG) -->
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect width='100' height='100' rx='20' fill='%23fff'/><rect width='100' height='30' fill='%23d32f2f'/><text x='50' y='75' font-family='tahoma' font-size='50' text-anchor='middle' fill='%23333'>۱</text></svg>">
    <link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect width='100' height='100' rx='20' fill='%23fff'/><rect width='100' height='30' fill='%23d32f2f'/><text x='50' y='75' font-family='tahoma' font-size='50' text-anchor='middle' fill='%23333'>۱</text></svg>">

    <title>استیکر تقویم درویشی</title>
    <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@300;400;700;900&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Vazirmatn', sans-serif;
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            overflow-x: hidden;
            background: #e0e0e0;
        }

        .container {
            text-align: center;
            padding: 20px;
            width: 100%;
            max-width: 500px;
        }

        #canvas-container {
            position: relative;
            width: 100%;
            aspect-ratio: 1/1;
            margin: 0 auto 20px;
            background-image: linear-gradient(45deg, #ccc 25%, transparent 25%), 
                              linear-gradient(-45deg, #ccc 25%, transparent 25%), 
                              linear-gradient(45deg, transparent 75%, #ccc 75%), 
                              linear-gradient(-45deg, transparent 75%, #ccc 75%);
            background-size: 20px 20px;
            background-position: 0 0, 0 10px, 10px -10px, -10px 0px;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.15);
        }

        canvas { width: 100%; height: 100%; display: block; }
        .controls { display: flex; gap: 10px; justify-content: center; flex-wrap: wrap; }

        button {
            font-family: 'Vazirmatn', sans-serif;
            background: #000;
            color: #fff;
            border: none;
            padding: 15px 35px;
            font-size: 18px;
            font-weight: bold;
            border-radius: 50px;
            cursor: pointer;
            transition: transform 0.2s;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }
        button:active { transform: scale(0.95); }

        #status { margin-top: 15px; font-size: 16px; color: #333; min-height: 20px; font-weight: bold; }
        .install-btn { display: none; background: #4CAF50; margin-top: 10px; }
    </style>
</head>
<body>

    <div class="container">
        <div id="canvas-container">
            <canvas id="calendarCanvas" width="1000" height="1000"></canvas>
        </div>
        
        <div class="controls">
            <button id="download-btn">دانلود استیکر (PNG)</button>
        </div>
        <button id="install-btn" class="install-btn">نصب اپلیکیشن</button>
        <div id="status"></div>
    </div>

    <script>
        const canvas = document.getElementById('calendarCanvas');
        const ctx = canvas.getContext('2d');
        const statusDiv = document.getElementById('status');
        const downloadBtn = document.getElementById('download-btn');
        const installBtn = document.getElementById('install-btn');

        // PWA Install Logic
        let deferredPrompt;
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            installBtn.style.display = 'block';
        });
        installBtn.addEventListener('click', async () => {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                deferredPrompt.userChoice.then(() => deferredPrompt = null);
                installBtn.style.display = 'none';
            }
        });

        // Register Service Worker
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('sw.js')
              .then(reg => console.log('SW Registered'))
              .catch(err => console.error('SW Error', err));
        }

        function toPersianNum(num) {
            const id = ['۰', '۱', '۲', '۳', '۴', '۵', '۶', '۷', '۸', '۹'];
            return String(num).replace(/[0-9]/g, (w) => id[+w]);
        }

        function gregorian_to_jalali(gy, gm, gd) {
            const g_d_m = [0, 31, 59, 90, 120, 151, 181, 212, 243, 273, 304, 334];
            let jy = (gy <= 1600) ? 0 : 979;
            gy -= (gy <= 1600) ? 621 : 1600;
            const gy2 = (gm > 2) ? (gy + 1) : gy;
            let days = (365 * gy) + (parseInt((gy2 + 3) / 4)) - (parseInt((gy2 + 99) / 100)) + (parseInt((gy2 + 399) / 400)) - 80 + gd + g_d_m[gm - 1];
            jy += 33 * (parseInt(days / 12053));
            days %= 12053;
            jy += 4 * (parseInt(days / 1461));
            days %= 1461;
            jy += parseInt((days - 1) / 365);
            if (days > 365) days = (days - 1) % 365;
            const jm = (days < 186) ? 1 + parseInt(days / 31) : 7 + parseInt((days - 186) / 30);
            const jd = 1 + ((days < 186) ? (days % 31) : ((days - 186) % 30));
            return [jy, jm, jd];
        }

        const persianMonths = ["فروردین", "اردیبهشت", "خرداد", "تیر", "مرداد", "شهریور", "مهر", "آبان", "آذر", "دی", "بهمن", "اسفند"];
        const weekDays = ["یکشنبه", "دوشنبه", "سه‌شنبه", "چهارشنبه", "پنجشنبه", "جمعه", "شنبه"];
        const events = {
            "1-1": "آغاز سال نو", "1-2": "عید نوروز", "1-3": "عید نوروز", "1-4": "عید نوروز",
            "1-12": "روز جمهوری اسلامی", "1-13": "روز طبیعت",
            "3-14": "رحلت امام خمینی (ره)", "3-15": "قیام ۱۵ خرداد",
            "11-22": "پیروزی انقلاب اسلامی", "12-29": "روز ملی شدن صنعت نفت"
        };

        const themes = {
            spring: { card: '#ffffff', text: '#1b5e20', accent: '#2e7d32', light: '#e8f5e9' },
            summer: { card: '#ffffff', text: '#e65100', accent: '#ef6c00', light: '#fff3e0' },
            autumn: { card: '#ffffff', text: '#4e342e', accent: '#5d4037', light: '#efebe9' },
            winter: { card: '#ffffff', text: '#37474f', accent: '#546e7a', light: '#eceff1' }
        };

        let currentDate = new Date();

        function getDateInfo() {
            const d = currentDate;
            const [jy, jm, jd] = gregorian_to_jalali(d.getFullYear(), d.getMonth() + 1, d.getDate());
            const dayOfWeek = d.getDay();
            let season = 'spring';
            if (jm >= 1 && jm <= 3) season = 'spring';
            else if (jm >= 4 && jm <= 6) season = 'summer';
            else if (jm >= 7 && jm <= 9) season = 'autumn';
            else season = 'winter';
            return {
                year: jy, month: persianMonths[jm - 1], day: jd, weekDay: weekDays[dayOfWeek],
                event: events[`${jm}-${jd}`] || "", seasonKey: season
            };
        }

        function drawRoundedRect(x, y, w, h, r) {
            ctx.beginPath();
            ctx.moveTo(x + r, y);
            ctx.lineTo(x + w - r, y);
            ctx.quadraticCurveTo(x + w, y, x + w, y + r);
            ctx.lineTo(x + w, y + h - r);
            ctx.quadraticCurveTo(x + w, y + h, x + w - r, y + h);
            ctx.lineTo(x + r, y + h);
            ctx.quadraticCurveTo(x, y + h, x, y + h - r);
            ctx.lineTo(x, y + r);
            ctx.quadraticCurveTo(x, y, x + r, y);
            ctx.closePath();
        }

        function drawGraphic(info) {
            const theme = themes[info.seasonKey];
            
            ctx.clearRect(0, 0, 1000, 1000);
            ctx.shadowColor = 'rgba(0, 0, 0, 0.25)';
            ctx.shadowBlur = 50;
            ctx.shadowOffsetY = 15;

            const padX = 40, padY = 40;
            const cardW = 920, cardH = 920;
            ctx.fillStyle = theme.card;
            drawRoundedRect(padX, padY, cardW, cardH, 60);
            ctx.fill();

            ctx.shadowColor = 'transparent';
            ctx.textAlign = 'center';
            const centerX = 500;
            let currentY = 0;

            // Brand Name
            currentY = 130;
            ctx.font = '900 70px Vazirmatn';
            ctx.fillStyle = '#111111';
            ctx.fillText('بازرگانی درویشی', centerX, currentY);

            // Subtitle
            currentY += 50;
            ctx.font = '400 35px Vazirmatn';
            ctx.fillStyle = '#555555';
            ctx.fillText('واردات و پخش لوازم جانبی', centerX, currentY);

            // Separator
            currentY += 40;
            ctx.strokeStyle = theme.light;
            ctx.lineWidth = 6;
            ctx.beginPath(); ctx.moveTo(150, currentY); ctx.lineTo(850, currentY); ctx.stroke();

            // Day Number
            currentY += 250;
            ctx.font = '900 380px Vazirmatn';
            ctx.fillStyle = theme.text;
            ctx.fillText(toPersianNum(info.day), centerX, currentY);

            // Month
            currentY += 90;
            ctx.font = '900 90px Vazirmatn';
            ctx.fillStyle = theme.accent;
            ctx.fillText(info.month, centerX, currentY);

            // Year & Weekday
            currentY += 80;
            ctx.font = '700 45px Vazirmatn';
            ctx.fillStyle = theme.text;
            ctx.fillText(`سال ${toPersianNum(info.year)} | ${info.weekDay}`, centerX, currentY);

            // Event
            if (info.event) {
                currentY += 50;
                ctx.font = '700 35px Vazirmatn';
                ctx.fillStyle = '#d32f2f';
                ctx.fillText(info.event, centerX, currentY);
            }

            // Footer
            const footerY = 820;
            ctx.strokeStyle = theme.light;
            ctx.lineWidth = 6;
            ctx.beginPath(); ctx.moveTo(150, footerY); ctx.lineTo(850, footerY); ctx.stroke();

            // WhatsApp
            ctx.font = '900 50px Vazirmatn';
            ctx.fillStyle = '#25D366';
            ctx.fillText('واتس‌اپ: ۰۹۳۳۹۱۷۷۰۰۰۰', centerX, footerY + 70);

            // Telegram
            ctx.font = '700 40px Vazirmatn';
            ctx.fillStyle = '#0088cc';
            ctx.fillText('تلگرام: t.me/janebi_darvishi_deylam', centerX, footerY + 130);
        }

        downloadBtn.addEventListener('click', () => {
            statusDiv.textContent = 'در حال آماده سازی...';
            const link = document.createElement('a');
            const info = getDateInfo();
            link.download = `Sticker-Darvishi-${info.day}.png`;
            link.href = canvas.toDataURL('image/png');
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            statusDiv.textContent = '✅ استیکر دانلود شد.';
        });

        document.fonts.ready.then(() => {
            const info = getDateInfo();
            drawGraphic(info);
        });
    </script>
</body>
</html>